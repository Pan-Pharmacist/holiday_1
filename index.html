<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #4F46E5; --secondary: #EC4899; }
        body { font-family: 'Sarabun', sans-serif; background: #F3F4F6; color: #1F2937; }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .nav-item.active { background: #EEF2FF; color: var(--primary); border-right: 4px solid var(--primary); }
        .page-transition { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .avatar-group { display: flex; -space-x-2: -0.5rem; }
        .fc-event { border: none; font-size: 0.75rem; cursor: pointer; transition: transform 0.2s; }
        .fc-event:hover { transform: scale(1.05); z-index: 10; }
        
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; }
        }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen flex">

    <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-700">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl text-center">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-indigo-600 shadow">
                <i class="fa-solid fa-pills"></i>
            </div>
            <h1 class="text-2xl font-bold mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å</h1>
            <p class="text-gray-500 mb-6 text-sm">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°</p>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="user" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <input type="password" id="pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
        </div>
    </div>

    <div id="passModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
            <h3 class="text-lg font-bold mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <div class="space-y-3">
                <input type="password" id="oldPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" class="w-full border p-2 rounded">
                <input type="password" id="newPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" class="w-full border p-2 rounded">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="document.getElementById('passModal').classList.add('hidden')" class="px-3 py-1 text-gray-500 hover:bg-gray-100 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="changePass()" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <nav id="sidebar" class="w-64 bg-white border-r border-gray-200 h-full hidden flex-col z-20">
        <div class="p-5 border-b flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded text-white flex items-center justify-center"><i class="fa-solid fa-hospital"></i></div>
            <h2 class="font-bold text-gray-700">‡∏™‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h2>
        </div>
        <div class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            <button onclick="nav('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-600 active"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</button>
            <button onclick="nav('form')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-file-pen w-5"></i> ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
            <button onclick="nav('calendar')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-regular fa-calendar w-5"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
            <button onclick="nav('history')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-clock-rotate-left w-5"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
            
            <div id="adminMenu" class="hidden pt-4 mt-4 border-t">
                <p class="px-4 text-xs font-bold text-gray-400 mb-2 uppercase">Administrator</p>
                <button onclick="nav('adminQuota')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-purple-600"><i class="fa-solid fa-lock w-5"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤/‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</button>
                <button onclick="nav('adminReport')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-purple-600"><i class="fa-solid fa-table w-5"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & Logs</button>
                <button onclick="nav('adminUsers')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-purple-600"><i class="fa-solid fa-users-gear w-5"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
            </div>
        </div>
        <div class="p-4 border-t bg-gray-50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs cursor-pointer" onclick="document.getElementById('passModal').classList.remove('hidden')" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" id="avt">U</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate" id="uName">User</p>
                    <button onclick="logout()" class="text-xs text-red-500 hover:underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <main id="main" class="flex-1 h-full overflow-y-auto p-6 hidden relative bg-gray-50">
        <div id="loader" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center hidden"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-600"></i></div>

        <div id="view-dashboard" class="page-transition">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Overview)</h2>
                <div class="flex gap-2">
                    <select id="dashMonth" class="bg-white border rounded px-3 py-1 text-sm"></select>
                    <button onclick="loadDashboard()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Refresh</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-injured text-orange-500"></i> ‡πÉ‡∏Ñ‡∏£‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ? (Who's Off)</h3>
                    <div id="whoOffContainer" class="flex flex-wrap gap-3">
                        <span class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-pink-500">
                    <p class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <div class="flex items-end gap-1 mt-2">
                        <h3 class="text-4xl font-bold text-gray-800" id="statPersonal">0</h3>
                        <span class="text-gray-400 text-sm mb-1">/365 ‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                        <div class="bg-pink-500 h-2 rounded-full transition-all duration-500" id="statBar" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4 text-sm text-gray-600">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3><canvas id="chartDaily"></canvas></div>
                <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4 text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3><div class="h-64 flex justify-center"><canvas id="chartType"></canvas></div></div>
            </div>
        </div>

        <div id="view-form" class="hidden page-transition">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                <h2 class="text-xl font-bold mb-6 border-b pb-4">üìù ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤</h2>
                <form id="leaveForm" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-sm font-medium block mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</label><select id="inpPh" class="w-full border rounded-lg p-2.5 bg-gray-50"></select></div>
                        <div><label class="text-sm font-medium block mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="inpType" class="w-full border rounded-lg p-2.5"></select></div>
                    </div>
                    <div><label class="text-sm font-medium block mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="inpNote" class="w-full border rounded-lg p-2.5" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <label class="text-sm font-bold text-indigo-900 mb-2 block">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="inpStart" class="border rounded p-2" required>
                            <input type="date" id="inpEnd" class="border rounded p-2" required>
                        </div>
                        <p class="text-xs text-indigo-600 mt-2">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>
                    <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
                </form>
            </div>
        </div>

        <div id="view-calendar" class="hidden page-transition h-full flex flex-col">
            <div class="bg-white p-4 rounded-xl shadow-sm flex-1"><div id="calendar" class="h-full"></div></div>
        </div>

        <div id="view-history" class="hidden page-transition">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button onclick="printMyHistory()" class="bg-gray-700 text-white px-3 py-1 rounded text-sm hover:bg-gray-800"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-600"><tr><th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th class="p-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-adminQuota" class="hidden page-transition">
            <div class="max-w-4xl mx-auto space-y-6">
                <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <h2 class="text-xl font-bold mb-4">üîí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© / Lock</h2>
                    <div class="flex flex-wrap items-end gap-4 bg-gray-50 p-4 rounded-lg">
                        <div><label class="text-xs font-bold text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="admDate" class="border rounded p-2"></div>
                        <div><label class="text-xs font-bold text-gray-500">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (0=Lock)</label><input type="number" id="admQ" class="border rounded p-2 w-24"></div>
                        <button onclick="setLock()" class="bg-orange-600 text-white px-4 py-2 rounded font-bold hover:bg-orange-700">Update</button>
                        <button onclick="setLock(true)" class="text-sm underline text-gray-500">Reset</button>
                    </div>
                </div>
                
                <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-red-500">
                    <h2 class="text-xl font-bold mb-4">üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</h2>
                    <div class="flex gap-4 items-end">
                        <input type="date" id="holDate" class="border rounded p-2">
                        <input type="text" id="holName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î" class="border rounded p-2 w-full">
                        <button onclick="addHoliday()" class="bg-red-600 text-white px-4 py-2 rounded font-bold hover:bg-red-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-adminReport" class="hidden page-transition space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h3>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="repS" class="border rounded p-2"><input type="date" id="repE" class="border rounded p-2">
                    <button onclick="loadReport()" class="bg-purple-600 text-white px-4 rounded">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 rounded">Excel</button>
                </div>
                <div class="max-h-64 overflow-y-auto border rounded"><table class="w-full text-sm"><tbody id="repBody"></tbody></table></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Audit Logs)</h3>
                <div id="logBody" class="h-48 overflow-y-auto bg-gray-50 p-2 text-xs font-mono border rounded text-gray-600"></div>
            </div>
        </div>

        <div id="view-adminUsers" class="hidden page-transition">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£</h3>
                    <form onsubmit="addUser(event)" class="space-y-3">
                        <input id="newUName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full border p-2 rounded">
                        <div class="flex gap-2"><input id="newUUser" placeholder="Username" class="w-full border p-2 rounded"><input id="newUPass" placeholder="Password" class="w-full border p-2 rounded"></div>
                        <button class="bg-blue-600 text-white w-full py-2 rounded hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
                    <form onsubmit="addType(event)" class="flex gap-2">
                        <input id="newTName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" class="w-full border p-2 rounded">
                        <button class="bg-green-600 text-white px-4 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                </div>
            </div>
        </div>

    </main>

    <div id="printSection" class="hidden">
        <h1 class="text-2xl font-bold text-center mb-6">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h1>
        <p class="mb-4"><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="pName"></span></p>
        <table class="w-full border-collapse border border-black text-sm">
            <thead><tr class="bg-gray-200"><th class="border border-black p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="border border-black p-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="border border-black p-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead>
            <tbody id="pBody"></tbody>
        </table>
    </div>

    <script>
        // *** CONFIG ***
        const API = 'https://script.google.com/macros/s/AKfycbwoEYoxb7FSwtuCtc3SdLiBkrCbN98enwnQ8itTXU7jBpTUCpevWcbPYBkmJ6oQu6ucOA/exec'; 

        let USER=null, DATA=null, CAL=null, CHART={};

        // AUTH
        document.getElementById('loginForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const res = await req({action:'login', username:document.getElementById('user').value, password:document.getElementById('pass').value}, true);
            if(res.success){ USER=res.user; init(); } else Swal.fire('Error', res.message, 'error');
        });
        function logout(){ location.reload(); }
        async function changePass(){
            const oldP=document.getElementById('oldPass').value, newP=document.getElementById('newPass').value;
            if(!oldP || !newP) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','warning');
            const res = await req({action:'chgPass', userId:USER.id, oldPass:oldP, newPass:newP}, true);
            if(res.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',res.message,'success'); document.getElementById('passModal').classList.add('hidden'); }
            else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',res.message,'error');
        }

        // INIT
        async function init(){
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden'); document.getElementById('sidebar').classList.add('flex');
            document.getElementById('main').classList.remove('hidden');
            document.getElementById('uName').innerText = USER.name; document.getElementById('avt').innerText = USER.name[0];
            if(USER.role==='admin') document.getElementById('adminMenu').classList.remove('hidden');

            const res = await req({action:'init'}, true); DATA=res;
            
            const ph = document.getElementById('inpPh');
            ph.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'+res.users.map(u=>`<option value="${u.name}">${u.name}</option>`);
            if(USER.role!=='admin'){ ph.value=USER.name; ph.disabled=true; }
            
            document.getElementById('inpType').innerHTML=res.types.map(t=>`<option value="${t.name}">${t.name}</option>`);
            
            initDash(); nav('dashboard');
        }

        function nav(id){
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('[id^="view-"]').forEach(v=>v.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            if(id==='calendar') loadCal();
            if(id==='history') loadHist();
            if(id==='adminReport') loadLogs();
        }

        // FORMS
        document.getElementById('leaveForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const res = await req({
                action:'submit', pharmacist:document.getElementById('inpPh').value, type:document.getElementById('inpType').value,
                note:document.getElementById('inpNote').value, start:document.getElementById('inpStart').value, end:document.getElementById('inpEnd').value,
                userId:USER.id, role:USER.role
            }, true);
            if(res.success){ Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',res.message,'success'); document.getElementById('inpNote').value=''; loadDashboard(); }
            else Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',res.message,'warning');
        });

        // DASHBOARD
        function initDash(){
            const m=document.getElementById('dashMonth');
            ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'].forEach((x,i)=>m.innerHTML+=`<option value="${i+1}">${x}</option>`);
            m.value=new Date().getMonth()+1; loadDash();
        }
        async function loadDash(){
            const res = await req({action:'dashboard', month:document.getElementById('dashMonth').value, year:new Date().getFullYear()});
            document.getElementById('statTotal').innerText = res.total;
            
            // Render Who's Off
            const wc = document.getElementById('whoOffContainer');
            wc.innerHTML = res.whoOff.length ? '' : '<p class="text-gray-400 text-sm italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
            res.whoOff.forEach(p => {
                const color = (DATA.types.find(t=>t.name===p.type)||{}).color || '#666';
                wc.innerHTML += `<div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-100">
                    <div class="w-2 h-2 rounded-full" style="background:${color}"></div>
                    <div><p class="text-sm font-bold text-gray-700">${p.name}</p><p class="text-xs text-gray-500">${p.type} (${p.date})</p></div>
                </div>`;
            });

            if(CHART.d) CHART.d.destroy(); CHART.d = new Chart(document.getElementById('chartDaily'), {type:'bar',data:{labels:Object.keys(res.daily),datasets:[{label:'‡∏Ñ‡∏ô',data:Object.values(res.daily),backgroundColor:'#4F46E5',borderRadius:4}]}});
            if(CHART.t) CHART.t.destroy(); CHART.t = new Chart(document.getElementById('chartType'), {type:'doughnut',data:{labels:Object.keys(res.types),datasets:[{data:Object.values(res.types),backgroundColor:['#4F46E5','#EC4899','#10B981']}]}});
        }

        // CALENDAR
        function loadCal(){
            if(CAL){ CAL.refetchEvents(); return; }
            CAL = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView:'dayGridMonth', locale:'th', height:'100%',
                events: async(i,s)=> {
                    const leaves = await req({action:'calendar', start:i.startStr, end:i.endStr});
                    // Add Holidays
                    const holidays = DATA.holidays.map(h => ({
                        title: `üõë ${h.name}`, start: h.date, display: 'background', color: '#ffcccc'
                    }));
                    s([...leaves, ...holidays]);
                },
                eventContent: arg => {
                    return { html: arg.event.display === 'background' ? '' : `<div class="px-1 truncate"><span class="w-2 h-2 inline-block rounded-full mr-1" style="background:${arg.event.backgroundColor}"></span>${arg.event.title}</div>` }
                }
            });
            CAL.render();
        }

        // HISTORY
        async function loadHist(){
            const res = await req({action:'myHistory', userId:USER.id});
            const tb = document.getElementById('histBody'); tb.innerHTML='';
            const used=res.length, lim=DATA.userLimit||15;
            document.getElementById('statPersonal').innerHTML=`${used}<span class="text-sm text-gray-400">/${lim}</span>`;
            document.getElementById('statBar').style.width=Math.min((used/lim)*100,100)+'%';
            res.forEach(r=>{
                tb.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-indigo-900">${r.date}</td><td class="p-4">${r.type}</td><td class="p-4 text-gray-500">${r.note||'-'}</td><td class="p-4 text-right"><button onclick="del('${r.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('pName').innerText = USER.name;
            document.getElementById('pBody').innerHTML = res.map(r=>`<tr><td class="border border-black p-2">${r.date}</td><td class="border border-black p-2">${r.type}</td><td class="border border-black p-2">${r.note||'-'}</td></tr>`).join('');
        }
        function printMyHistory(){ window.print(); }
        async function del(id){ if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')){ await req({action:'delete', id, userId:USER.id}, true); loadHist(); } }

        // ADMIN
        async function setLock(rst=false){
            const d=document.getElementById('admDate').value, q=document.getElementById('admQ').value;
            if(!d) return; const res = await req({action:'setLock', date:d, quota:rst?null:q, userId:USER.id}, true); Swal.fire('Info', res.message, 'success');
        }
        async function addHoliday(){
            const d=document.getElementById('holDate').value, n=document.getElementById('holName').value;
            if(!d||!n) return; await req({action:'addHoliday', date:d, name:n, userId:USER.id}, true); Swal.fire('Success','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
        }
        async function loadReport(){
            const s=document.getElementById('repS').value, e=document.getElementById('repE').value;
            if(!s) return;
            const res = await req({action:'report', start:s, end:e});
            DATA.report = res;
            document.getElementById('repBody').innerHTML = res.map(r=>`<tr class="border-b"><td class="p-2">${r.date}</td><td class="p-2">${r.pharmacist}</td><td class="p-2">${r.type}</td><td class="p-2">${r.note||''}</td></tr>`).join('');
        }
        function exportExcel(){
            if(!DATA.report) return alert('Load report first');
            XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(DATA.report), "Report")), "Report.xlsx");
        }
        async function loadLogs(){
            const res = await req({action:'getLogs'});
            document.getElementById('logBody').innerHTML = res.map(l=>`<div>[${l.time}] <b>${l.user}</b>: ${l.action} ${l.details}</div>`).join('');
        }
        async function addUser(e){ e.preventDefault(); await req({action:'addUser', name:document.getElementById('newUName').value, username:document.getElementById('newUUser').value, password:document.getElementById('newUPass').value}, true); Swal.fire('Added','','success'); }
        async function addType(e){ e.preventDefault(); await req({action:'addType', name:document.getElementById('newTName').value, color:'#555'}, true); Swal.fire('Added','','success'); }

        // UTILS
        async function req(body, load=false){
            if(load) document.getElementById('loader').classList.remove('hidden');
            const r = await fetch(API, {method:'POST', body:JSON.stringify(body)}).then(x=>x.json());
            if(load) document.getElementById('loader').classList.add('hidden');
            return r;
        }
    </script>
</body>
</html>
